import pefile
import os
import shutil
from os import listdir
from os.path import isfile, join
import shutil
import os
import pandas as pd

directory = "MALWR2"

malwr_file_names = [f for f in listdir(directory) if isfile(join(directory, f)) if f != ".DS_Store"]

# for file_name in malwr_file_names:
#     target_file_name = file_name + ""
#     pe = pefile.PE(f"{directory}/"+file_name)
#     needs_unpack = False
#     for section in pe.sections:
#         if "UPX" in section.Name.decode(errors='replace',):
#             needs_unpack = True
#     if needs_unpack:
#         target_file_name += "_unpacked"
#         os.system("upx -d " + f"{directory}/" + file_name)

#     original = f"{directory}/" + file_name
#     target = "CLEAN/"+target_file_name
#     shutil.copyfile(original, target)

# clean_file_names = [f for f in listdir("CLEAN") if isfile(join("CLEAN", f)) if f != ".DS_Store"]

malwr_texts = []
names = []
for file_name in malwr_file_names:
    print("name: ", file_name)
    pe = pefile.PE(f"{directory}/"+file_name)
    # names.append(file_name)
    # needs_unpack = False
    # sections_text = "Sections:\n"
    print("Sections:")
    for section in pe.sections:
        print("\t", section.Name, hex(section.VirtualAddress), hex(section.Misc_VirtualSize), section.SizeOfRawData)
        print("\t", section.Name.decode(errors='replace',).rstrip('\x00'))

    print("Size of image ", pe.OPTIONAL_HEADER.SizeOfImage)
    print("ImageBase ", pe.OPTIONAL_HEADER.ImageBase)

    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        print('Llamadas DLL:')
        print (entry.dll)
        print('Llamadas a funciones:')
        for function in entry.imports:
            print ('\t', function.name)
    print("TimeDateStamp : " + pe.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])

    print()
